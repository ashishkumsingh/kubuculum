---
# tasks file for bench_fiorand gather

- name: get fio pod name
  command: 'kubectl get pods -l {{ bench_fiorand_podlabel }} --namespace={{ bench_fiorand_namespace }} --no-headers -o custom-columns=":metadata.name"'
  register: podlist

- name: create directory for storing fio pod output
  file: 
    path: '{{ run_dir }}/{{ role_name }}/{{ item }}'
    state: directory
  with_items: "{{ podlist.stdout_lines }}"

- name: fetch output from fio pod
  command: 'kubectl cp {{ bench_fiorand_namespace }}/{{ item }}:{{ bench_fiorand_podoutdir }} {{ run_dir }}/{{ role_name }}/{{ item}}'
  with_items: "{{ podlist.stdout_lines }}"

- name: fetch df from fio pod
  shell: 'kubectl exec {{ item }} -c {{ bench_fiorand_container }} -n {{ bench_fiorand_namespace }} -- df -h > {{ run_dir }}/{{ role_name }}/{{ item }}/df_h.txt'
  with_items: "{{ podlist.stdout_lines }}"

- name: fetch mount from fio pod
  shell: 'kubectl exec {{ item }} -c {{ bench_fiorand_container }} -n {{ bench_fiorand_namespace }} -- mount > {{ run_dir }}/{{ role_name }}/{{ item }}/mount.txt'
  with_items: "{{ podlist.stdout_lines }}"

- name: get fio pod location
  shell: 'kubectl get pods -l {{ bench_fiorand_podlabel }} --namespace={{ bench_fiorand_namespace }} -o wide >> {{ run_dir }}/out.{{ role_name }}.txt'
...
